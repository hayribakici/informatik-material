<!doctype html>
<html lang="de">
    <!--Vibe Code-->
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Urnenmodell</title>
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
        />
        <style>
            body {
                font-family: sans-serif;
                padding: 20px;
                display: flex;
                gap: 40px;
            }
            #left {
                width: 270px;
                display: flex;
                flex-direction: column;
                gap: 8px;
            }
            .row {
                display: flex;
                gap: 10px;
            }
            .row .color input {
                flex: 1;
            }
            .row input {
                padding: 4px;
                font-size: 12px;
            }
            #canvas {
                position: absolute;
                top: 0;
                left: 0;
            }
            #right {
                position: relative;
                width: 420px;
                height: 420px;
                /*margin-left: 1px; /* vorher: 0 */*/
            }
        </style>
    </head>
    <body>
        <div id="left">
            <h1>Urnenmodell Generator</h1>
            <div id="rows"></div>
            <button id="addRow"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div
            id="right"
            style="
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
            "
        >
            <div style="position: relative; width: 210px; height: 210px">
                <img
                    src="urn.png"
                    style="
                        position: absolute;
                        width: 100%;
                        height: 100%;
                        pointer-events: none;
                    "
                />
                <canvas
                    id="canvas"
                    width="210"
                    height="210"
                    style="position: absolute; top: 0; left: 0"
                ></canvas>
            </div>

            <div style="display: flex; gap: 12px">
                <button id="downloadBtn">
                    <i class="fa-solid fa-download"></i>
                </button>
                <button id="copyBtn"><i class="fa-solid fa-copy"></i></button>
            </div>
        </div>

        <script>
            const rows = document.getElementById("rows");
            const addRowBtn = document.getElementById("addRow");
            const downloadBtn = document.getElementById("downloadBtn");
            const copyBtn = document.getElementById("copyBtn");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");

            const urnImage = new Image();
            urnImage.src = "./urn.png";
            ("2d");

            addRowBtn.addEventListener("click", () => addRow());
            addRow();

            downloadBtn.addEventListener("click", function () {
                var link = document.createElement("a");
                link.download = "urne.png";
                link.href = canvas.toDataURL();
                link.click();
            });

            copyBtn.addEventListener("click", function () {
                canvas.toBlob(function (blob) {
                    navigator.clipboard.write([
                        new ClipboardItem({ "image/png": blob }),
                    ]);
                });
            });

            function addRow(color = "", count = 1) {
                const row = document.createElement("div");
                row.className = "row";

                const colorInput = document.createElement("input");
                colorInput.className = "color";
                colorInput.placeholder = "Farbe";
                colorInput.value = color;

                const countInput = document.createElement("input");
                countInput.type = "number";
                countInput.style.width = "32px";
                countInput.min = 0;
                countInput.value = count;

                const delBtn = document.createElement("button");
                delBtn.innerHTML = '<i class="fa-solid fa-minus"></i>';
                delBtn.style.width = "32px";
                delBtn.addEventListener("click", () => {
                    row.remove();
                    update();
                });

                colorInput.addEventListener("input", update);
                countInput.addEventListener("input", update);

                row.appendChild(colorInput);
                row.appendChild(countInput);
                row.appendChild(delBtn);
                rows.appendChild(row);

                update();
            }

            function update() {
                const allRows = document.querySelectorAll("#rows .row");
                let balls = [];

                allRows.forEach((r) => {
                    const color = r.children[0].value.trim();
                    if (!isValidColor(color)) return;
                    const count = parseInt(r.children[1].value) || 0;
                    for (let i = 0; i < count; i++) balls.push(color);
                });

                drawBalls(balls);
            }

            function drawBalls(balls) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (urnImage.complete) {
                    ctx.drawImage(urnImage, 0, 0, canvas.width, canvas.height);
                }

                const cx = canvas.width / 2;
                const cy = canvas.height / 2;

                const urnRadius = 82;
                const r = 8;
                const pad = 2;

                let y = cy + urnRadius - r - 1;

                function rowMaxWidth(y) {
                    const dy = cy - y;
                    const w = Math.sqrt(
                        Math.max(urnRadius * urnRadius - dy * dy, 0),
                    );
                    return w * 2;
                }

                function drawRow(colors, y) {
                    const spacing = 2 * r + pad;
                    const totalWidth = colors.length * spacing;
                    const startX = cx - totalWidth / 2 + r;

                    colors.forEach((color, i) => {
                        const x = startX + i * spacing;

                        ctx.beginPath();
                        ctx.arc(x, y, r, 0, Math.PI * 2);
                        ctx.fillStyle = color;
                        ctx.fill();
                        ctx.stroke();
                    });
                }

                let row = [];
                let rowWidth = 0;
                let maxWidth = rowMaxWidth(y);

                balls.forEach((color) => {
                    const ballWidth = 2 * r + pad;

                    if (rowWidth + ballWidth > maxWidth) {
                        drawRow(row, y);
                        row = [];
                        rowWidth = 0;

                        y -= 2 * r + pad;
                        maxWidth = rowMaxWidth(y);
                    }

                    row.push(color);
                    rowWidth += ballWidth;
                });

                if (row.length > 0) {
                    drawRow(row, y);
                }
            }

            function isValidColor(str) {
                var s = document.createElement("div");
                s.style.color = str;
                return s.style.color !== "";
            }
        </script>
    </body>
</html>
